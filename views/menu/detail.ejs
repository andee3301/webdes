<%- include('../partials/header') %>
<section class="row g-4">
  <div class="col-md-6">
    <% if (item.imageUrl) { %>
    <img src="<%= item.imageUrl %>" class="img-fluid rounded shadow-sm" alt="<%= item.name %>" />
    <% } else { %>
    <div class="bg-light border rounded p-5 text-center text-muted">No image available</div>
    <% } %>
  </div>
  <div class="col-md-6">
    <h1 class="h3"><%= item.name %></h1>
    <p class="text-muted"><%= item.description || 'Crafted with care.' %></p>
    <div class="d-flex align-items-center gap-3 mb-3">
      <span class="fs-4 fw-bold">$<%= parseFloat(item.price).toFixed(2) %></span>
      <% if (!item.isAvailable) { %>
      <span class="badge bg-secondary">Unavailable</span>
      <% } else if (item.stock !== null && item.stock !== undefined) { %>
        <% if (item.stock === 0) { %>
        <span class="badge bg-danger">Out of stock</span>
        <% } else if (item.stock < 10) { %>
        <span class="badge bg-warning text-dark">Only <%= item.stock %> left</span>
        <% } else { %>
        <span class="badge bg-success">In stock</span>
        <% } %>
      <% } %>
    </div>
    <% if (avgRating) { %>
    <p class="mb-2">Average rating: <strong><%= avgRating %></strong> from <%= reviewCount %> reviews</p>
    <% } else { %>
    <p class="text-muted">No reviews yet.</p>
    <% } %>
    <div class="d-flex gap-2 align-items-center mb-4">
      <form action="/cart/add/<%= item.id %>" method="POST" class="d-flex gap-2">
        <input class="form-control" style="width: 120px" type="number" name="quantity" min="1" 
          <% if (item.stock !== null && item.stock !== undefined) { %>
            max="<%= item.stock %>"
          <% } %>
          value="1" />
        <button class="btn btn-primary" type="submit" 
          <%= (item.isAvailable && (item.stock === null || item.stock === undefined || item.stock > 0)) ? '' : 'disabled' %>>
          <%= (item.stock === 0) ? 'Out of stock' : 'Add to cart' %>
        </button>
      </form>
      <% if (user) { %>
      <% if (isWishlisted) { %>
      <form action="/wishlist/<%= item.id %>/remove" method="POST">
        <button class="btn btn-outline-secondary" type="submit">♥ In wishlist</button>
      </form>
      <% } else { %>
      <form action="/wishlist/<%= item.id %>/add" method="POST">
        <button class="btn btn-outline-primary" type="submit">♡ Save</button>
      </form>
      <% } %> <% } else { %>
      <a class="btn btn-link" href="/login">Login to save</a>
      <% } %>
    </div>
  </div>
</section>

<section class="mt-5">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="h4">Reviews</h2>
    <% if (user) { %>
    <span class="text-muted small">Reviews are moderated before appearing.</span>
    <% } %>
  </div>
  <% if (user) { %>
  <form action="/menu/<%= item.id %>/reviews" method="POST" class="card card-body shadow-sm mb-4">
    <div class="row g-3">
      <div class="col-md-3">
        <label class="form-label">Rating</label>
        <select class="form-select" name="rating" required>
          <option value="">Select</option>
          <% for (let i = 5; i >= 1; i--) { %>
          <option value="<%= i %>"><%= i %> / 5</option>
          <% } %>
        </select>
      </div>
      <div class="col-md-9">
        <label class="form-label">Comment</label>
        <textarea class="form-control" name="comment" rows="3" required></textarea>
      </div>
    </div>
    <div class="mt-3">
      <button class="btn btn-primary" type="submit">Submit review</button>
    </div>
  </form>
  <% } else { %>
  <div class="alert alert-light border">
    <a href="/login">Login</a> to leave a review.
  </div>
  <% } %>

  <% if (reviews && reviews.length) { %>
  <div class="list-group">
    <% reviews.forEach((review) => { %>
    <div class="list-group-item">
      <div class="d-flex justify-content-between align-items-center mb-1">
        <strong><%= review.user?.name || 'Guest' %></strong>
        <span class="text-warning">★ <%= review.rating %>/5</span>
      </div>
      <p class="mb-1"><%= review.comment %></p>
      <small class="text-muted"><%= new Date(review.createdAt).toLocaleDateString() %></small>
    </div>
    <% }); %>
  </div>
  <% } else { %>
  <p class="text-muted">No reviews yet.</p>
  <% } %>
</section>
<%- include('../partials/footer') %>
